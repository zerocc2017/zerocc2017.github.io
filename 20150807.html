<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>iOS 开发之多线程中问题分析 | zerocc2014</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS 开发之多线程中问题分析</h1><a id="logo" href="/.">zerocc2014</a><p class="description">桃李春风一杯酒，江湖夜雨十年灯</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/reads/"><i class="fa fa-folder"> 阅读</i></a><a href="/codes/"><i class="fa fa-star"> 干货</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS 开发之多线程中问题分析</h1><div class="post-meta">2015年08月07日</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">一. 多线程开发中常见问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-%E7%BA%BF%E7%A8%8B%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">二. 线程死锁分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">三. 任务执行顺序分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">四. 线程安全分析</span></a></li></ol></div></div><div class="post-content"><a id="more"></a>

<h1 id="一-多线程开发中常见问题"><a href="#一-多线程开发中常见问题" class="headerlink" title="一. 多线程开发中常见问题"></a>一. 多线程开发中常见问题</h1><p><strong>多线程死锁（Deadlock）：</strong>如果两个（有时候多个）线程都在等着对方完成任务才能执行自己的任务时，这种情况我们成为死锁。第一个线程要等到第二个线程执行完才能执行，而第二个线程则在等着第一个线程，所以两个都永远无法执行。</p>
<p><strong>线程安全（Thread Safe）：</strong>多个线程在执行任务过程中，因访问同一块资源，这个资源可以是同一个对象、同一个变量、同一个文件和同一个方法等，从而导致数据错误及数据不安全等问题。没有线程安全的代码同一时间内只能被在一个上下文中运行，线程安全的代码可以被多个线程或者并发任务安全地调用而不会引发任何问题。</p>
<p><strong>上下文切换（Context Switch）：</strong>一次上下文切换是指在一个单核处理器中，保存和恢复不同线程的执行状态的过程。在编写多任务应用的时候，这个切换是很常见的，但是这种切换也会带来额外的开销。</p>
<p><strong>临界区（Critical Section）：</strong>临界区值是不能被并发执行的代码块，也即不能被两个及以上的线程同时访问。这通常是因为这段代码访问了一份共享资源，而且这个资源在被访问的过程中不能中断。</p>
<p><strong>竞争条件（Race Condition）：</strong>当软件系统的行为依赖于无法控制的事件的执行顺序时（比如程序并发任务的执行顺序），我们称这种情况为竞争条件。竞争条件会产生无法预测的结果，通常代码走查也没法发现明显的问题。</p>
<h1 id="二-线程死锁分析"><a href="#二-线程死锁分析" class="headerlink" title="二. 线程死锁分析"></a>二. 线程死锁分析</h1><p>串行与并行针对的是队列，队列特性 FIFO 原则执行任务，串行队列一个个任务取出让任务一个接着一个地执行，并发队列也是FIFO 原则取出任务，但它取出来一个就会放到一个线程，然后再取出来一个又放到另一个的线程，取的动作快就感觉是一起并发执行的；</p>
<p>同步与异步针对的是线程，最大的区别在于，同步线程要阻塞当前线程，必须要等待同步线程中的任务执行完，返回以后，才能继续执行下一任务；而异步线程则是不用等待。</p>
<p>使用同步 sync 函数往当前串行队列中添加任务，会卡住当前的串行队列（产生死锁）；</p>
<p>死锁场景一（同步执行 + 串行队列）：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步执行 + 串行队列 (主线程调用此方法)</span></span><br><span class="line">- (<span class="keyword">void</span>)syncAndSerialQueue &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.zerocc.serialQueue&quot;</span>,DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue,^&#123; <span class="comment">// block块任务 A</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;2---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_sync</span>(queue,^&#123; <span class="comment">// block块任务 B</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;3---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;4---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;5---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码执行结果 </span></span><br><span class="line">... CCBlogCode[<span class="number">51579</span>:<span class="number">8397296</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0x6000020753c0</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">51579</span>:<span class="number">8397296</span>] <span class="number">5</span>---&lt;NSThread: <span class="number">0x6000020753c0</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">51579</span>:<span class="number">8397379</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0x6000020fd340</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure>

<p>分析：执行完到 2 后崩溃<code>Thread 2: EXC_BAD_INSTRUCTION (code=EXC_I386_INVOP, subcode=0x0)</code>。</p>
<ul>
<li>1 和 5 是主线程中的任务，block块任务 A 是异步 async 不会阻塞当前线程主线程，所以 1 和 5 执行没问题；</li>
<li>异步线程中，block块任务 A 加入到串行队列中。因为是异步执行所以 2 也能正常执行，且 5 和 2 执行顺序不定；</li>
<li>2 执行完以后，遇到同步的 block块任务 B 也添加到同一队列中，队列的特点是遵循 FIFO 原则执行任务，其中 任务 A 是先加入到队列中，任务 B 是后加入的，也就是说 3 的执行要等待 2 和 4 都执行完才会从队列中取出执行，但是这里 4 的执行又要等待 3 执行完，因为 sync 是同步执行他会阻塞当前线程，然后就 3 和 4 的执行就互相等待了；</li>
</ul>
<p>死锁场景二（同步执行 + 串行队列）：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步执行 + 主队列 (主线程调用此方法) 死锁</span></span><br><span class="line">- (<span class="keyword">void</span>)syncAndMainQueue&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(),^&#123; <span class="comment">// block块任务 A</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;3&quot;</span>);</span><br><span class="line">    <span class="comment">// 死锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行结果</span></span><br><span class="line">... CCBlogCode[<span class="number">60058</span>:<span class="number">10806609</span>] <span class="number">1</span></span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure>

<p>分析：执行完 1 后崩溃 <code>Thread 1: EXC_BAD_INSTRUCTION (code=EXC_I386_INVOP, subcode=0x0)</code></p>
<ul>
<li>syncAndMainQueue 方法主线程调用说明 1 和 3 是在主队列中执行，也就是说 syncAndMainQueue 方法执行的代码块是先添加在主队列的任务， 主队列有一定隐蔽性特殊；这里 1 打印没有异议；</li>
<li>block块任务 A 中代码 2 的执行也是添加在主队列，任务 A 是在 syncAndMainQueue 方法执行任务之后添加进主队列的，那么 2 的执行需等 syncAndMainQueue 方法执行完，也就是 1 和 3 执行完，所以 2 的执行需等待 3 执行完；</li>
<li>但是 任务 A 又是通过 sync 函数同步执行方式添加入队列，那么他就会阻塞当前线程-主线程，需等 2 执行完后才能继续往下执行 3；这样 2 和 3 的执行就互相等待了；</li>
</ul>
<h1 id="三-任务执行顺序分析"><a href="#三-任务执行顺序分析" class="headerlink" title="三. 任务执行顺序分析"></a>三. 任务执行顺序分析</h1><p><strong>1. 子线程中调用 sync 函数并将任务添加入另一个串行队列</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步执行 + 另一个串行队列</span></span><br><span class="line">- (<span class="keyword">void</span>)syncAndOtherSerialQueue &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.zerocc.serialQueue&quot;</span>,DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">&quot;com.zerocc.serialQueue3&quot;</span>,DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue,^&#123; <span class="comment">// block块任务 A</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;2---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同步执行阻塞当前线程, sync 不具备开启新线程，所以一定是先执行 3 再 4</span></span><br><span class="line">        <span class="built_in">dispatch_sync</span>(queue2,^&#123; <span class="comment">// block块任务 B</span></span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;3---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;4---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;5---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    <span class="comment">// 执行结果 15234</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行打印结果</span></span><br><span class="line">... CCBlogCode[<span class="number">61800</span>:<span class="number">11440133</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0x600001401400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">61800</span>:<span class="number">11440133</span>] <span class="number">5</span>---&lt;NSThread: <span class="number">0x600001401400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">61800</span>:<span class="number">11440370</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0x60000145b480</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">61800</span>:<span class="number">11440370</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0x60000145b480</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">61800</span>:<span class="number">11440370</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0x60000145b480</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果分析：152执行顺序，5 和 2顺序不定；同步执行函数任务B添加到另一个串行队列，因为是不同队列不存在 3 等 4执行完再执行，但是 sync 函数是不具备开启新线程在当前线程同步执行那么就一定是先执行 3 再执行 4；如果这里将queue2 改为并发队列执行结果也一样，</p>
<p><strong>2. 子线程中调用 async 函数并将任务添加入同一个串行队列</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步执行 + 串行队列 (主线程调用此方法) 同一队列 FIFO</span></span><br><span class="line">- (<span class="keyword">void</span>)asyncAndSerialQueue &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.zerocc.serialQueue&quot;</span>,DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue,^&#123; <span class="comment">// block块任务 A</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;2---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同一串行队列 FIFO，先执行完任务 A 中的代码再执行B，所以先4 后 3</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(queue,^&#123; <span class="comment">// block块任务 B</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;3---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;4---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;5---%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    <span class="comment">// 执行结果 15243</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码执行结果</span></span><br><span class="line">... CCBlogCode[<span class="number">53073</span>:<span class="number">8457204</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0x6000005dc2c0</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">53073</span>:<span class="number">8457204</span>] <span class="number">5</span>---&lt;NSThread: <span class="number">0x6000005dc2c0</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line">... CCBlogCode[<span class="number">53073</span>:<span class="number">8457256</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0x600000550b00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">53073</span>:<span class="number">8457256</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0x600000550b00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">53073</span>:<span class="number">8457256</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0x600000550b00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果分析：152执行顺序，5 和 2顺序不定；因为是同一个串行队列，那么他只能开启一个线程，尽管调用了 async 异步执行函数，任务 B 还是在当前线程执行，然后同一队列 3 是最后添加到队列中的所以3 等待 4执行完再执行。如果这个同一队列是并发队列，那就是并发执行了 3 4 谁快谁先执行，同一并发队列又是 async 会开启新线程， 虽然也FIFO，但是会将任务从并发队列中取出仍到多个线程中执行，所以 3 4就不定了。</p>
<h1 id="四-线程安全分析"><a href="#四-线程安全分析" class="headerlink" title="四. 线程安全分析"></a>四. 线程安全分析</h1><p>一块资源可能会被多个线程共享，也就是多个线程可能会访问同一块资源，比如多个线程访问同一个对象、同一个变量、同一个文件和同一个方法等。因此当多个线程访问同一块资源时，很容易会发生数据错误及数据不安全等问题。因此要避免这些问题，我们需要使用线程同步技术。先看示例，下篇再进行分析线程锁及其运用细节。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存取钱场景示例</span></span><br><span class="line">- (<span class="keyword">void</span>)moneySaveAndDrawScene &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.money = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.zerocc.money&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            [<span class="keyword">self</span> moneySave];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            [<span class="keyword">self</span> moneyDraw];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存钱 10 元</span></span><br><span class="line">- (<span class="keyword">void</span>)moneySave</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> oldMoney = <span class="keyword">self</span>.money;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    oldMoney += <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">self</span>.money = oldMoney;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;存10，还剩%d元 - %@&quot;</span>, oldMoney, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取钱 10 元</span></span><br><span class="line">- (<span class="keyword">void</span>)moneyDraw</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> oldMoney = <span class="keyword">self</span>.money;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    oldMoney -= <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">self</span>.money = oldMoney;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;取10，还剩%d元 - %@&quot;</span>, oldMoney, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行结果打印</span></span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838714</span>] 存<span class="number">10</span>，还剩<span class="number">110</span>元 - &lt;NSThread: <span class="number">0x60000180da80</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838717</span>] 取<span class="number">10</span>，还剩<span class="number">90</span>元 - &lt;NSThread: <span class="number">0x60000180db00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838717</span>] 取<span class="number">10</span>，还剩<span class="number">100</span>元 - &lt;NSThread: <span class="number">0x60000180db00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838714</span>] 存<span class="number">10</span>，还剩<span class="number">120</span>元 - &lt;NSThread: <span class="number">0x60000180da80</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838717</span>] 取<span class="number">10</span>，还剩<span class="number">110</span>元 - &lt;NSThread: <span class="number">0x60000180db00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838714</span>] 存<span class="number">10</span>，还剩<span class="number">130</span>元 - &lt;NSThread: <span class="number">0x60000180da80</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838714</span>] 存<span class="number">10</span>，还剩<span class="number">120</span>元 - &lt;NSThread: <span class="number">0x60000180da80</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838717</span>] 取<span class="number">10</span>，还剩<span class="number">100</span>元 - &lt;NSThread: <span class="number">0x60000180db00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838717</span>] 取<span class="number">10</span>，还剩<span class="number">90</span>元 - &lt;NSThread: <span class="number">0x60000180db00</span>&gt;&#123;number = <span class="number">3</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">... CCBlogCode[<span class="number">65160</span>:<span class="number">11838714</span>] 存<span class="number">10</span>，还剩<span class="number">110</span>元 - &lt;NSThread: <span class="number">0x60000180da80</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>示例分析：显然总共 100 元，存5次取5次 10元正确结果应该还是100，但是最后结果却是 110 元，显然数据出错。至于如何解决下篇文章继续。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/potato512/article/details/43703317?locationNum=1">多线程开发——线程安全</a></p>
<p><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/79149/grand-central-dispatch-tutorial-swift-part-1">raywenderlich grand-central-dispatch</a></p>
<p><a target="_blank" rel="noopener" href="https://justinyan.me/post/2420">枫影 GCD 翻译文章</a></p>
</blockquote>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>iOS 开发之多线程中问题分析</p><p><span>文章作者：</span>zerocc</p><p><span>发布时间：</span>2015年08月07日</p><p><span>原始链接：</span><a href="/20150807.html">http://www.zerocc.com.cn/20150807.html</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="http://www.zerocc.com.cn/20150807.html"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://www.zerocc.com.cn/20150807.html" data-id="ckiebskwb001rdsxb4rpg2ugf" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABx0lEQVR42u3ay26EMAwFUP7/p+m2iyG9tiG01ckKjVDmhIXlR44jXufFWr/5/ZerN48nFi4u7ph7LlfCvTrA1S/5/h+OhIuLu5G7DjTrrZN91ocpBDtcXNxfyU0oyW64uLj/iZv88foAuLi4f4WblDfVFCcPXo/Uari4uANu3qV87vmR/i4uLm6LexZXvs88eH3YExcXdws3Dyjrpmf1kNVmCi4u7k5ur4C5q4VaDYu4uLh7uL3hR3LNotpanSRYuLi493KrLc5k1FG9tlVo1+Li4m7k5tEup+fFT5Jg4eLivsXNJxe9BGWSGB29b4CLi3srNx+K9IYuvY+Ci4v7FndS/OSt1Wbqg4uLu4VbSC9aly0md6uiPXFxcTdyJ82RfJ9qIYSLi7uTmyQWhbQjLqKSD/HDnRFcXNyHudUQc9dAJT8kLi7ufm5h2NlqoPQOfJRPg4uLO+XOR6S9sWuS7uDi4r7FrQaX0Yh03JzFxcXdyc2DTjU1mQSyZqKDi4t7K7cXaKqDk16TJeri4OLivsrNn3vl082BDBcX9yVuFT0Zz+Di4u7kVguV6gAmKXKioIaLi7uF2xt89lon1a7tqL+Li4vb4X4BQtmaeZIcyOUAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/iOS/"><i class="fa fa-tag"></i>iOS</a></div><div class="post-nav"><a class="pre" href="/20150807.html">iOS 开发之多线程中线程锁</a><a class="next" href="/20150806.html">iOS 开发之多线程 NSOperation</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zMTcyMy84Mjg3"><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.zerocc.com.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%B6%E5%85%89%E6%B2%99%E6%BC%8F/">时光沙漏</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/1602816267.html">Widget Extension in iOS 14</a></li><li class="post-list-item"><a class="post-list-link" href="/20190602.html">后来的我们</a></li><li class="post-list-item"><a class="post-list-link" href="/20181017.html">凌晨三点</a></li><li class="post-list-item"><a class="post-list-link" href="/1602472154.html">hexo博客主题更换 maupassant 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/20181001.html">iOS - 苹果内购</a></li><li class="post-list-item"><a class="post-list-link" href="/20180312.html">希望我们冷漠且礼貌的相处</a></li><li class="post-list-item"><a class="post-list-link" href="/20180101.html">归来仍是少年</a></li><li class="post-list-item"><a class="post-list-link" href="/20171123.html">iOS 中证书和签名机制</a></li><li class="post-list-item"><a class="post-list-link" href="/1603866527.html">Cocopods 包管理工具使用</a></li><li class="post-list-item"><a class="post-list-link" href="/1602472277.html">hexo博客必用插件</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/iOS/" style="font-size: 25px;">iOS</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/hexo/" style="font-size: 18.33px;">hexo</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/%E7%BB%88%E7%AB%AF%E6%8C%87%E4%BB%A4/" style="font-size: 15px;">终端指令</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 18.33px;">服务器</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 21.67px;">随笔</a> <a href="/tags/%E5%BF%83%E6%83%85/" style="font-size: 15px;">心情</a> <a href="/tags/iOS-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" style="font-size: 18.33px;">iOS 第三方源码阅读</a> <a href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" style="font-size: 15px;">源码阅读</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 15px;">密码学</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%B1%82/" style="font-size: 15px;">网络层</a> <a href="/tags/iOS-%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84/" style="font-size: 15px;">iOS 底层结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">zerocc2014.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>